{% extends "/account/account.html" %} {% block content %}
<div class="flex h-[80vh] overflow-hidden">
  <!-- Sidebar -->
  <div class="w-1/3 bg-gray-100 border-r overflow-y-auto">
    <div class="p-4 font-bold text-xl">Messages</div>

    <!-- New Conversation Button -->
    <div class="px-4 mb-2">
      <button
        onclick="startConversation()"
        class="bg-green-500 hover:bg-green-600 text-white w-full py-2 rounded-lg text-sm"
      >
        + Start New Conversation
      </button>
    </div>

    <!-- Message List -->
    <ul>
      {% for msg in messages %}
      <li
        class="px-4 py-2 border-b cursor-pointer hover:bg-gray-200 {{ 'bg-blue-100' if not msg.sender else 'bg-orange-100' }}"
        onclick="showMessage({{ msg.id }})"
      >
        <div class="font-semibold">
          {% if not msg.sender %} To {{ msg.receiver }} {% else %} From {{
          msg.sender }} {% endif %}
        </div>
        <div class="text-sm text-gray-600 truncate">
          {{ msg.message | truncate(50, True, '...') }}
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Main Panel -->
  <div class="flex-1 flex flex-col">
    <!-- Message Content -->
    <div id="message-detail" class="flex-1 p-6 overflow-y-auto">
      <p class="text-gray-700">Select a message to view details.</p>
    </div>

    <!-- Input Field -->
    <div class="border-t p-4">
      <form
        id="reply-form"
        class="flex flex-col gap-2"
        enctype="multipart/form-data"
      >
        <input type="hidden" name="receiver_id" id="receiver-id" />
        <input
          type="text"
          name="message"
          placeholder="Type a reply..."
          class="p-2 border rounded-lg"
        />
        <input
          type="file"
          name="shared_file"
          id="shared-file"
          accept=".json"
          class="p-2 border rounded-lg"
        />
        <button
          type="submit"
          class="bg-blue-500 text-white px-4 py-2 rounded-lg"
        >
          Send
        </button>
      </form>
    </div>
  </div>
</div>

<script>
      const messages = {{ messages|tojson }};

    function showMessage(id) {
      const msg = messages.find(m => m.id === id);
      const detail = document.getElementById('message-detail');
      const receiverIdInput = document.getElementById('receiver-id');

      // Correctly set receiverId based on whether current user is sender or receiver
      const currentUserId = {{ current_user.id }};
      receiverIdInput.value = (msg.sender_id === currentUserId) ? msg.receiver_id : msg.sender_id;

      const createdAt = new Date(msg.created_at);
      const formattedTime = createdAt.toLocaleString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });

      let html = `
        <h2 class="text-2xl font-bold mb-2">Sender: ${!msg.sender ? "Me" : msg.sender}</h2>
        <h2 class="text-xl font-bold mb-2">Receiver: ${!msg.sender ? msg.receiver : "Me"}</h2>
        <p class="text-sm text-gray-500 mb-2">Sent at: ${formattedTime}</p>
        <p class="mb-4">${msg.message}</p>
      `;

      if (msg.shared_data) {
        const fields = {
          conn_country: 'Country',
          episode_name: 'Episode',
          episode_show_name: 'Show',
          master_metadata_track_name: 'Track',
          master_metadata_album_artist_name: 'Artist',
          master_metadata_album_album_name: 'Album'
        };

        const headers = Object.values(fields);
        const keys = Object.keys(fields);

        let tableHeader = headers.map(h => `<th class="border px-2 py-1">${h}</th>`).join('');
        let tableRows = msg.shared_data.map(row =>
          `<tr>${keys.map(key => `<td class="border px-2 py-1">${row[key] !== null ? row[key] : ''}</td>`).join('')}</tr>`
        ).join('');

        html += `
          <table class="table-auto border-collapse border w-full text-sm mb-4">
            <thead><tr>${tableHeader}</tr></thead>
            <tbody>${tableRows}</tbody>
          </table>
        `;
      }

      detail.innerHTML = html;
    }


    document.getElementById('reply-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const receiverId = document.getElementById('receiver-id').value;
      const messageText = this.message.value.trim();
      const sharedFile = document.getElementById('shared-file').files[0];

      if (!receiverId) {
        alert('Please select a conversation or start a new one.');
        return;
      }

      if (!messageText && !sharedFile) {
        alert('You must enter a message or upload a file.');
        return;
      }

      const formData = new FormData();
      formData.append('receiver_id', receiverId);
      formData.append('message', messageText);
      if (sharedFile) {
        formData.append('shared_file', sharedFile);
      }

      const response = await fetch('/messages/send', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      if (result.success) {
        alert('Message sent!');
        const savedReceiverId = receiverId;
        this.reset();
        document.getElementById('receiver-id').value = savedReceiverId;
        location.reload();
      } else {
        alert('Failed to send: ' + result.error);
      }
    });

    async function startConversation() {
    const email = prompt("Enter the receiver's email:");
    if (!email) return;

    const response = await fetch('/messages/find_user', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email: email })
    });

    const result = await response.json();
    if (result.success) {
      // Success: set the receiver_id and clear the detail panel
      document.getElementById('receiver-id').value = result.user_id;
      document.getElementById('message-detail').innerHTML = `
        <h2 class="text-2xl font-bold mb-2">New Conversation with ${result.username}</h2>
        <p class="text-gray-500 mb-2">Start typing your message below!</p>
      `;
    } else {
      alert('User not found!');
    }
  }
</script>
{% endblock %}
