{% extends "/account/account.html" %} {% block content %}
<div class="flex h-[80vh] overflow-hidden">
  <!-- Sidebar -->
  <div class="w-1/3 bg-gray-100 border-r overflow-y-auto">
    <div class="p-4 font-bold text-xl">Messages</div>
    <ul>
      {% for msg in messages %}
      <li
        class="px-4 py-2 border-b cursor-pointer hover:bg-gray-200 {{ 'bg-blue-100' if not msg.sender else 'bg-orange-100' }}"
        onclick="showMessage({{ msg.id }})"
      >
        <div class="font-semibold">
          {% if not msg.sender %} To {{ msg.receiver }} {% else %} From {{
          msg.sender }} {% endif %}
        </div>
        <div class="text-sm text-gray-600 truncate">
          {{ msg.message | truncate(50, True, '...') }}
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Main Panel -->
  <div class="flex-1 flex flex-col">
    <!-- Message Content -->
    <div id="message-detail" class="flex-1 p-6 overflow-y-auto">
      <p class="text-gray-700">Select a message to view details.</p>
    </div>

    <!-- Input Field -->
    <div class="border-t p-4">
      <form id="reply-form" class="flex gap-2">
        <input type="hidden" name="receiver_id" id="receiver-id" />
        <input
          type="text"
          name="message"
          placeholder="Type a reply..."
          class="flex-1 p-2 border rounded-lg"
        />
        <button
          type="submit"
          class="bg-blue-500 text-white px-4 py-2 rounded-lg"
        >
          Send
        </button>
      </form>
    </div>
  </div>
</div>

<script>
    const messages = {{ messages|tojson }};

    function showMessage(id) {
      const currentUserId = {{ current_user.id }};
      const msg = messages.find(m => m.id === id);
      const detail = document.getElementById('message-detail');
      const receiverIdInput = document.getElementById('receiver-id');
      receiverIdInput.value = msg.sender_id === currentUserId ? msg.receiver_id : msg.sender_id;

      const createdAt = new Date(msg.created_at);
      const formattedTime = createdAt.toLocaleString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });

      let html = `
        <h2 class="text-2xl font-bold mb-2">Sender: ${!msg.sender ? "Me" : msg.sender}</h2>
        <h2 class="text-xl font mb-2">Receiver: ${!msg.sender ? msg.receiver : "Me"}</h2>
        <p class="text-sm text-gray-500 mb-2">Sent at: ${formattedTime}</p>
        <p class="mb-4">${msg.message}</p>
      `;

      if (msg.shared_data) {
        const rows = msg.shared_data.map(row =>
          `<tr>${row.map(cell => `<td class="border px-2 py-1">${cell}</td>`).join('')}</tr>`
        ).join('');
        html += `<table class="table-auto border-collapse border w-full">${rows}</table>`;
      }

      detail.innerHTML = html;
    }

    document.getElementById('reply-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const receiverId = document.getElementById('receiver-id').value;
      const messageText = this.message.value.trim();
      console.log(receiverId, messageText);

      if (!messageText) return;

      const response = await fetch('/messages/send', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          receiver_id: receiverId,
          message: messageText
        })
      });

      const result = await response.json();
      if (result.success) {
        alert('Message sent!');
        this.reset();
        location.reload();
      } else {
        alert('Failed to send: ' + result.error);
      }
  });
</script>
{% endblock %}
